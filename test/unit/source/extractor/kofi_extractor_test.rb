require "test_helper"

module Source::Tests::Extractor
  class KofiExtractorTest < ActiveSupport::ExtractorTestCase
    context "A sample image URL" do
      strategy_should_work(
        "https://storage.ko-fi.com/cdn/useruploads/post/2c42fc4c-6ebb-4b09-9da0-d14b19a105b1_d69ed1ef-bb4c-4c9f-96ed-4cac35ab8c0d.png",
        image_urls: %w[https://storage.ko-fi.com/cdn/useruploads/display/2c42fc4c-6ebb-4b09-9da0-d14b19a105b1_d69ed1ef-bb4c-4c9f-96ed-4cac35ab8c0d.png],
        media_files: [{ file_size: 607_634 }],
        page_url: nil,
        profile_urls: [],
        display_name: nil,
        username: nil,
        tags: [],
        dtext_artist_commentary_title: "",
        dtext_artist_commentary_desc: "",
      )
    end

    context "A full image URL" do
      strategy_should_work(
        "https://storage.ko-fi.com/cdn/useruploads/display/2c42fc4c-6ebb-4b09-9da0-d14b19a105b1_d69ed1ef-bb4c-4c9f-96ed-4cac35ab8c0d.png",
        image_urls: %w[https://storage.ko-fi.com/cdn/useruploads/display/2c42fc4c-6ebb-4b09-9da0-d14b19a105b1_d69ed1ef-bb4c-4c9f-96ed-4cac35ab8c0d.png],
        media_files: [{ file_size: 607_634 }],
        page_url: nil,
        profile_urls: [],
        display_name: nil,
        username: nil,
        tags: [],
        dtext_artist_commentary_title: "",
        dtext_artist_commentary_desc: "",
      )
    end

    context "A gallery item with multiple images" do
      strategy_should_work(
        "https://ko-fi.com/i/IV7V6X5X5F",
        image_urls: %w[
          https://storage.ko-fi.com/cdn/useruploads/d1d0171b-f1ca-4e37-9eaf-36e67bdf1adc_pto.png
          https://storage.ko-fi.com/cdn/useruploads/74c47e75-bf57-44fa-915c-61289bc49433_jgf-----.png
          https://storage.ko-fi.com/cdn/useruploads/d4aa4710-e650-416a-b095-0e32715eed8f_jgf----.png
          https://storage.ko-fi.com/cdn/useruploads/3adb3c7e-b9f1-4b9d-9266-e101d8037dd6_jgf---.png
          https://storage.ko-fi.com/cdn/useruploads/7b1ec936-4061-450e-a156-a840759b249c_jgf--.png
          https://storage.ko-fi.com/cdn/useruploads/6f55b6e4-34ac-4a48-8a04-b808ad59044c_jgf-.png
        ],
        media_files: [
          { file_size: 522_613 },
          { file_size: 619_529 },
          { file_size: 369_934 },
          { file_size: 1_078_480 },
          { file_size: 426_912 },
          { file_size: 519_547 },
        ],
        page_url: "https://ko-fi.com/i/IV7V6X5X5F",
        profile_urls: %w[https://ko-fi.com/itssim https://ko-fi.com/D1D5VUW3P],
        display_name: "ItsSim",
        username: "itssim",
        tags: [],
        dtext_artist_commentary_title: "Requests from Discord art stream",
        dtext_artist_commentary_desc: "",
      )
    end

    context "A supporters-only gallery item" do
      strategy_should_work(
        "https://ko-fi.com/Gallery/LockedGalleryItem?id=IF1F6YVVVE#checkoutModal",
        image_urls: [],
        page_url: "https://ko-fi.com/i/IF1F6YVVVE",
        profile_urls: %w[https://ko-fi.com/sitraxis https://ko-fi.com/X8X668RY],
        display_name: "Tris",
        username: "sitraxis",
        tags: [],
        dtext_artist_commentary_title: "Shiki Animatic Frame Preview #15",
        dtext_artist_commentary_desc: "Available to monthly supporters",
      )
    end

    context "A commission page" do
      strategy_should_work(
        "https://ko-fi.com/c/840131e57b",
        image_urls: %w[
          https://storage.ko-fi.com/cdn/useruploads/display/ef2548c2-557c-43e1-b41d-60fe3fc1afd1_polytrixval.png
          https://storage.ko-fi.com/cdn/useruploads/display/f25dfbd2-6c60-494f-8b17-d9d64695b271_aleepy.png
          https://storage.ko-fi.com/cdn/useruploads/display/6226ed79-6f11-4852-a125-2fc4ed13f2df_woody2.png
          https://storage.ko-fi.com/cdn/useruploads/display/116f8a7c-10b0-4d1d-a1b0-158ccaa7a631_untitled_artwork45.png
          https://storage.ko-fi.com/cdn/useruploads/display/e46558c9-4abd-4d02-a6f4-f7a1f4bc7798_redmira.png
          https://storage.ko-fi.com/cdn/useruploads/display/080c7788-3a91-475d-8388-05f350c6f86d_griddlehark_cuddle.png
          https://storage.ko-fi.com/cdn/useruploads/display/da38655c-8abd-41da-ac40-c2c4ac2c1815_dowutin.png
          https://storage.ko-fi.com/cdn/useruploads/display/21524372-9e3d-49ab-9a8d-a80de5c91f9d_gid.png
          https://storage.ko-fi.com/cdn/useruploads/display/9454bbc0-e4f9-40a0-bd13-4535139399d5_tis_but_a_flesh_wound.png
        ],
        media_files: [
          { file_size: 908_017 },
          { file_size: 358_442 },
          { file_size: 310_050 },
          { file_size: 369_178 },
          { file_size: 965_921 },
          { file_size: 629_853 },
          { file_size: 323_672 },
          { file_size: 336_695 },
          { file_size: 525_601 },
        ],
        page_url: "https://ko-fi.com/c/840131e57b",
        profile_url: "https://ko-fi.com/gyngerwombatart",
        profile_urls: %w[https://ko-fi.com/gyngerwombatart https://ko-fi.com/D1D61UZW1U],
        display_name: "GyngerWombat",
        username: "gyngerwombatart",
        published_at: nil,
        updated_at: nil,
        tags: [],
        dtext_artist_commentary_title: "[Full Render] Full Body",
        dtext_artist_commentary_desc: <<~EOS.chomp,
          A fully rendered full body of up to three characters of your choice! NSFW content is allowed, but no Dead Dove content.

          B&W by default, but color can be added on.
        EOS
      )
    end

    context "A shop item" do
      strategy_should_work(
        "https://ko-fi.com/s/f0260080b5",
        image_urls: %w[
          https://storage.ko-fi.com/cdn/useruploads/display/cc189e63-5e80-4fd9-9f4a-478349d74446_valeriekschiscarameowpromo1.jpg
          https://storage.ko-fi.com/cdn/useruploads/display/9552b8d0-35f0-4425-a517-bf6f57b03023_valeriekschiscarameowpromo2.jpg
          https://storage.ko-fi.com/cdn/useruploads/display/f972f299-0084-49c1-b9c1-575f47bec247_valeriekschiscarameowpromo3.jpg
        ],
        media_files: [
          { file_size: 243_436 },
          { file_size: 205_088 },
          { file_size: 208_842 },
        ],
        page_url: "https://ko-fi.com/s/f0260080b5",
        profile_urls: %w[https://ko-fi.com/valerieks https://ko-fi.com/B0B219LZL],
        display_name: "valerieks",
        username: "valerieks",
        tags: [],
        dtext_artist_commentary_title: "Chiscarameow Discord Emoji",
        dtext_artist_commentary_desc: <<~EOS.chomp,
          Discord emoji pack for your server!

          Characters belong to HoYoverse.

          For personal use only, not for commercial use.

          Do not use for purposes other than discord emoji.

          Do not print, copy, reproduce, distribute, publish, modify, or in any way exploit the content.
        EOS
      )
    end

    context "A post page" do
      strategy_should_work(
        "https://ko-fi.com/post/Hooligans-Update-3-May-30th-2024-S6S0YPT5K",
        image_urls: %w[
          https://storage.ko-fi.com/cdn/useruploads/display/08a2aca4-b762-41be-906b-52f296ce486d_hooligans_covercopy.png
          https://storage.ko-fi.com/cdn/useruploads/display/25f82109-b36d-47e6-ab64-8688b9ab768f_hooligans_cover.png
        ],
        media_files: [
          { file_size: 345_395 },
          { file_size: 959_746 },
        ],
        page_url: "https://ko-fi.com/post/Hooligans-Update-3-May-30th-2024-S6S0YPT5K",
        profile_urls: %w[https://ko-fi.com/yonsoncb https://ko-fi.com/C0C33HKRP],
        display_name: "Yonson Carbonell",
        username: "yonsoncb",
        tags: [],
        dtext_artist_commentary_title: "Hooligans Update #3, May 30th 2024",
        dtext_artist_commentary_desc: <<~EOS.chomp,
          Hey everyone!!

          This update has good news and bad news, will do the good ones first hahaha.

          So, I'm glad to inform that we have a cover for the comic and I know I've been saying this is going to be free to read online like webtoons or something like that but I've been making it like if it was a traditional comic because you never know if it could get printed and I wanted to leave that window open.

          Here is the cover itself

          "[image]":[https://storage.ko-fi.com/cdn/useruploads/display/25f82109-b36d-47e6-ab64-8688b9ab768f_hooligans_cover.png]

          as you can see it features Clodagh as the main thing and I know some of you probably thought the main character in the story was Cillian and technically in a way he is because everything related to this project started with him but this story itself centers more around his mum and how they both had their first adventure together (him being stolen as baby and her on quest to get him back).

          Page wise I'm at page 21 and now this links to the bad news so up till this point I've been working on this comic on my iPad instead of my computer but 2 weeks ago my iPad out of nowhere died on me and right now I'm waiting for an update from the tech guy to see if it will fixable or not, luckily I did backed up all the hooligans files before all this happened so you don't have to worry about the comic being lost forever or something like that but without the iPad the progress will be be slower than it already was because there are days of the week im not home at all so with the iPad I could work on the go but now I can't so, I'm restricted to work only when I'm at home.

          but I'll keep at it, my goal before this incident was to get to page 30 before June so hopefully by the next update I'll have more than that hahaha.

          anyways... that's all for now, please let me know what you think about the cover.

          see you in the next update :D
        EOS
      )
    end

    context "A deleted or nonexistent gallery item" do
      strategy_should_work(
        "https://ko-fi.com/i/99999",
        image_urls: [],
        page_url: "https://ko-fi.com/i/99999",
        profile_urls: [],
        display_name: nil,
        username: nil,
        tags: [],
        dtext_artist_commentary_title: "",
        dtext_artist_commentary_desc: "",
      )
    end

    context "A deleted or nonexistent commissions page" do
      strategy_should_work(
        "https://ko-fi.com/c/bad",
        image_urls: [],
        page_url: "https://ko-fi.com/c/bad",
        profile_urls: [],
        display_name: nil,
        username: nil,
        tags: [],
        dtext_artist_commentary_title: "",
        dtext_artist_commentary_desc: "",
      )
    end

    context "A deleted or nonexistent post page" do
      strategy_should_work(
        "https://ko-fi.com/post/bad-bad",
        image_urls: [],
        page_url: "https://ko-fi.com/post/bad-bad",
        profile_urls: [],
        display_name: nil,
        username: nil,
        tags: [],
        dtext_artist_commentary_title: "",
        dtext_artist_commentary_desc: "",
      )
    end
  end
end
